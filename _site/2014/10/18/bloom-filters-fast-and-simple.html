<!DOCTYPE html><html lang="en" manifest="/manifest.appcache"> <!-- Magic. Do not touch! (c) 2011-2016 Maciej A. Czyzewski --><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><meta name="robots" content="index, follow, archive" /><meta name="referrer" content="always" /><title>Bloom filters, fast and simple - Maciej A. Czyzewski on the Web</title><meta property="og:title" content="Bloom filters, fast and simple" /><meta name="description" content="Everyone is always raving about bloom filters. But what exactly are they, and what are they useful for?" /><meta property="og:description" content="Everyone is always raving about bloom filters. But what exactly are they, and what are they useful for?" /><link rel="canonical" href="http://maciejczyzewski.me/2014/10/18/bloom-filters-fast-and-simple.html" /><meta property="og:url" content="http://maciejczyzewski.me/2014/10/18/bloom-filters-fast-and-simple.html" /><meta property="og:site_name" content="Maciej A. Czyzewski on the Web" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2014-10-18T13:14:00+02:00" /><link rel="next" href="http://maciejczyzewski.me/2014/10/19/year-2038-problem.html" title="Year 2038 problem" /><link rel="prev" href="http://maciejczyzewski.me/2014/09/03/ascii-table-from-dictionary-in-python.html" title="ASCII table from dictionary in Python" /><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@_czyzewski" /><meta name="google-site-verification" content="HBawTMww3xGdm4ZIKokBD8_Bx3YudVqrv1PISdhnthE" /> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "BlogPosting", "headline": "Bloom filters, fast and simple", "datePublished": "2014-10-18T13:14:00+02:00", "description": "Everyone is always raving about bloom filters. But what exactly are they, and what are they useful for?", "logo": "http://maciejczyzewski.me/assets/images/shortcuts/144.png", "url": "http://maciejczyzewski.me/2014/10/18/bloom-filters-fast-and-simple.html" } </script><link type="application/atom+xml" rel="alternate" href="http://maciejczyzewski.me/feed.xml" title="Maciej A. Czyzewski on the Web" /><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic,900,900italic" /> <script type="text/x-mathjax-config"> MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}}); </script> <script type="text/javascript" async src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML"></script><link media="all" rel="stylesheet" type="text/css" href="/assets/styles.css" /></head><line></line><header> <a href="/">Maciej A. Czyzewski</a> <a href="/archive">Archive</a> <a href="/research">Research</a> <a href="/projects">Projects</a> <a href="/talks">Talks</a> <a href="/about">About</a></header><main><article><h1>Bloom filters, fast and simple</h1><hgroup> <span>Posted on <time datetime="">18 October 2014</time></span> <a href="https://twitter.com/share" class="twitter-share-button" data-via="_czyzewski" data-size="large">Tweet</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></hgroup><div><p>Everyone is always raving about bloom filters. But what exactly are they, and what are they useful for?</p><blockquote><p>The Bloom filter is a space-efficient, probabilistic data structure – used to test whether an item does not belong to a collection.</p></blockquote><h2 id="operations">Operations</h2><p>The basic bloom filter supports two operations: <strong>add</strong> and <strong>query</strong>.</p><p><strong>Query</strong> is used to check whether a given element is in the set or not. It can only return a boolean value:</p><ul><li><em>true</em>, if the element is <strong>probably</strong> in the set.</li><li><em>false</em>, if the element is <strong>definitely not</strong> in the set.</li></ul><p><strong>Add</strong> simply adds an element to the set.</p><p>Removal is impossible without introducing false negatives, but there are versions where is possible to remove the element e.g. <a href="http://en.wikipedia.org/wiki/Bloom_filter#Counting_filters">counting filters</a>.</p><h2 id="structure">Structure</h2><p><img src="https://lh3.googleusercontent.com/OHB6BVcBF67x46vZpMzdGcSVCPHXK_efSU2BT6ie6pRnkVqs300efWhgfwsvAwgrCfZYQ8dGYRO-57BC4cjLvjy9-2Qc-ct0qF-0yMjhGwiSDIT4DfgKQqHPgJZRMO6AmTWCWNjObiANnL45I_jUNd29r_tgbkgsu7nRzGkfTUlXmQ0ibIoaczniDjBw42VjobokKYZfzRV9fcs0-MGYj3J_-n5je3y9cE7UGy1VaxbWPGzW96QDg9xBk_LC4oChEtm5jLvUlWUpjl6wO_LYMjjZcTVthkd2VM_1l5GnWiOml0uJSyEQLjOWX1kRDehusn2yMxbk57aMPSboGG8WG7-k1Of6RDoWAqy4o7aeqmuX1AaiRlK7pvYoOcD3f2Ta5FwUs9i5Z1I848or_0llmF4b9PF9Tn0icfrCuaM2vVf0LzkFg44_jtv4wr8PNg5HMS6jd9uo8nTsl-M0WXr0LT5p9bl6UIFf5sItfLVABeFLwarzoIiavoyEnpTdx32HxjHVTSKk7hWWsVEkgqPyQxKhvB8xCDgyNG7fhhqJQ_PNznfd2Tyc1kiJxFiZTN7InQYknbNQcEfouPViyi4ocEaH8sxJb9g=w1459-h1164-no" alt="Diagram" /></p><p>Internally Bloom filters use a bit array, and multiple different hash functions.</p><h2 id="example">Example</h2><p>Let’s say for instance we have a bit array of a <em>100 elements</em> and <em>3 hash functions</em>.</p><p><strong>Add</strong>, when we want to insert the word “Maciej” into the filter:</p><ul><li>We pass it through hash functions:</li><li>hash 1, returns 33</li><li>hash 2, returns 7</li><li>hash 3, returns 22</li><li>Next, we go to each of those elements in the array and set them to 1.</li></ul><p><strong>Query</strong>, now to test whether the word might be in the collection:</p><ul><li>We pass it through hash functions, and check those elements in the bit array:</li><li><em>true</em>, if all 3 elements are set to 1.</li><li><em>false</em>, if any one of the elements are set to zero.</li></ul><h2 id="implementation">Implementation</h2><figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>

<span class="k">class</span> <span class="nc">Filter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="s">"""A simple bloom filter for lots of int()"""</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">),</span> <span class="n">hashes</span><span class="o">=</span><span class="mi">13</span><span class="p">):</span>
    <span class="s">"""Initializes a Filter() object
    Expects:
      array_size (in bytes): 4 * 1024 for a 4KB filter
      hashes (int): for the number of hashes to perform
    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="nb">filter</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">array_size</span><span class="p">)</span>     <span class="c"># The filter itself</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bitcount</span> <span class="o">=</span> <span class="n">array_size</span> <span class="o">*</span> <span class="mi">8</span>          <span class="c"># Bits in the filter</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hashes</span> <span class="o">=</span> <span class="n">hashes</span>                    <span class="c"># The number of hashes to use</span>

  <span class="k">def</span> <span class="nf">_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="s">"""Creates a hash of an int and yields a generator of hash functions
    Expects:
      value: int()
    Yields:
      generator of ints()
    """</span>
    <span class="c"># Build an int() around the sha256 digest of int() -&gt; value</span>
    <span class="n">digest</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sha256</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">__str__</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hashes</span><span class="p">):</span>
      <span class="c"># bitwise AND of the digest and all of the available bit positions</span>
      <span class="c"># in the filter</span>
      <span class="k">yield</span> <span class="n">digest</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitcount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
      <span class="c"># Shift bits in digest to the right, based on 256 (in sha256)</span>
      <span class="c"># divided by the number of hashes needed be produced.</span>
      <span class="c"># Rounding the result by using int().</span>
      <span class="c"># So: digest &gt;&gt;= (256 / 13) would shift 19 bits to the right.</span>
      <span class="n">digest</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">256</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashes</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="s">"""Bitwise OR to add value(s) into the self.filter
    Expects:
      value: generator of digest ints()
    """</span>
    <span class="k">for</span> <span class="n">digest</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
      <span class="c"># In-place bitwise OR of the filter, position is determined</span>
      <span class="c"># by the (digest / 8) digest is described above in self._hash()</span>
      <span class="c"># Bitwise OR is undertaken on the value at the location and</span>
      <span class="c"># 2 to the power of digest modulo 8. Ex: 2 ** (30034 % 8)</span>
      <span class="c"># to grantee the value is &lt;= 128, the bytearray not being able</span>
      <span class="c"># to store a value &gt;= 256. Q: Why not use ((modulo 9) -1) then?</span>
      <span class="bp">self</span><span class="o">.</span><span class="nb">filter</span><span class="p">[(</span><span class="n">digest</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">digest</span> <span class="o">%</span> <span class="mi">8</span><span class="p">))</span>
      <span class="c"># The purpose here is to spread out the hashes to create a unique</span>
      <span class="c"># "fingerprint" with unique locations in the filter array,</span>
      <span class="c"># rather than just a big long hash blob.</span>

  <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="s">"""Bitwise AND to query values in self.filter
    Expects:
      value: value to check filter against (assumed int())
    """</span>
    <span class="c"># If all() hashes return True from a bitwise AND (the opposite</span>
    <span class="c"># described above in self.add()) for each digest returned from</span>
    <span class="c"># self._hash return True, else False</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="nb">filter</span><span class="p">[(</span><span class="n">digest</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">digest</span> <span class="o">%</span> <span class="mi">8</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">digest</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
  <span class="n">bf</span> <span class="o">=</span> <span class="n">Filter</span><span class="p">()</span>

  <span class="n">bf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span>
  <span class="n">bf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">40005</span><span class="p">)</span>
  <span class="n">bf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

  <span class="k">print</span><span class="p">(</span><span class="s">"Filter size {0} bytes"</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bf</span><span class="o">.</span><span class="nb">filter</span><span class="o">.</span><span class="n">__sizeof__</span><span class="p">())</span>

  <span class="k">print</span> <span class="n">bf</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>            <span class="c"># True</span>
  <span class="k">print</span> <span class="n">bf</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="mi">40005</span><span class="p">)</span>        <span class="c"># True</span>
  <span class="k">print</span> <span class="n">bf</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>          <span class="c"># False</span></code></pre></figure></div><nav> <a href="/2014/09/03/ascii-table-from-dictionary-in-python.html"><p>« previus</p><span>ASCII table from dictionary in Python</span> </a> <a href="/2014/10/19/year-2038-problem.html"><p>next »</p><span>Year 2038 problem</span> </a></nav></article></main><footer> (c) 2016 <a href="/feed.xml"><svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M12.8 16C12.8 8.978 7.022 3.2 0 3.2V0c8.777 0 16 7.223 16 16h-3.2zM2.194 11.61c1.21 0 2.195.985 2.195 2.196 0 1.21-.985 2.194-2.196 2.194C.984 16 0 15.017 0 13.806c0-1.21.983-2.195 2.194-2.195zM10.606 16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818 0 10.606 4.79 10.606 10.607z"/></svg></a></footer><script type="text/javascript">(function(e,t,n,r,i,s,o){e["GoogleAnalyticsObject"]=i;e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date;s=t.createElement(n),o=t.getElementsByTagName(n)[0];s.async=1;s.src=r;o.parentNode.insertBefore(s,o)})(window,document,"script","//www.google-analytics.com/analytics.js","ga");ga("create","UA-55884794-1","auto");ga("send","pageview")</script></body></html>
